;   THIS FILE IS PART OF JTCORES.
;   JTCORES PROGRAM IS FREE SOFTWARE: YOU CAN REDISTRIBUTE IT AND/OR MODIFY
;   IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
;   THE FREE SOFTWARE FOUNDATION, EITHER VERSION 3 OF THE LICENSE, OR
;   (AT YOUR OPTION) ANY LATER VERSION.
;
;   JTCORES PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL,
;   BUT WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
;   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  SEE THE
;   GNU GENERAL PUBLIC LICENSE FOR MORE DETAILS.
;
;   YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
;   ALONG WITH JTCORES.  IF NOT, SEE <HTTP://WWW.GNU.ORG/LICENSES/>.
;
;   AUTHOR: JOSE TEJADA GOMEZ. TWITTER: @TOPAPATE
;   VERSION: 1.0
;   DATE: 24-4-2023
;
;   FIRMWARE COMPATIBLE WITH ARKANOID 2

	RELAXED ON

CMD	EQU	$20

TOMAIN  MACRO   VAL
	MOV A,#VAL
	MOV STS,A	; Upper 4 bits can be read in the upper memory address
	MOV A,#VAL	; by the Z80
	OUT DBB,A
LOOP:   JOBF LOOP
	ENDM

WAITFF	MACRO		; wait for about 1ms
	MOV R1,#$FF
LOOP:	DJNZ R1,LOOP
	ENDM

READDB	MACRO
LOOP:	JNIBF LOOP
	IN A,DBB
	ENDM

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	ORG 0
	; ABSOLUTE ADDRESSING UPTO ADDRESS 7 = Timer interrupt
	JMP START
	NOP
	RETR    ; ADDRESS 3 = IRQ service
	NOP
	NOP
	RETR
START:      ; ADDRESS 7
	MOV A,#0
	MOV PSW,A
	DIS I
	DIS TCNTI
	STOP TCNT
	CLR F0
	CLR F1

	TOMAIN $55
	WAITFF

	TOMAIN $AA

	; Get 4 values for the coin settings
	MOV R0,#$30
	MOV R1,#4
RDCOIN:
	READDB
	CLR F1
	MOV @R0,A
	INC R0
	DJNZ R1,RDCOIN

	TOMAIN $5A

L:  	MOV R0,#CMD
	JNIBF CKCMD
	IN A,DBB
	JF0 A0WR
	CLR F1
	MOV @R0,A
	JMP CKCMD
A0WR:
CKCMD:	MOV A,#0
	MOV STS,A
	OUT DBB,A
	JMP L
